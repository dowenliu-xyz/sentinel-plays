dependencies {
    implementation("org.springframework.boot:spring-boot-starter")
    implementation("com.fasterxml.jackson.module:jackson-module-kotlin")
    implementation("org.jetbrains.kotlin:kotlin-reflect")
    implementation("com.alibaba.csp:sentinel-annotation-aspectj")
    implementation("com.alibaba.csp:sentinel-core")
    compileOnly("org.projectlombok:lombok")
    annotationProcessor("org.springframework.boot:spring-boot-configuration-processor")
    annotationProcessor("org.projectlombok:lombok")
    testImplementation("org.springframework.boot:spring-boot-starter-test")
    testRuntimeOnly("org.junit.platform:junit-platform-launcher")
}

tasks {
    create("generateDemos") {
        val basePkg = "org.example.eff.fallback.interfaces.cglib"
        doLast {
            mkdirs(basePkg)
            val cases = generateCases()
            cases.forEach { generateDemo(basePkg, it) }
            cases.forEach { generateCaseRunner(basePkg, it) }
        }
    }
}

fun mkdirs(basePkg: String) {
    val javaPkgPath = "src/main/java/${basePkg.replace(".", "/")}/demos"
    mkdir(javaPkgPath)
    val kotlinPkgPath = "src/main/kotlin/${basePkg.replace(".", "/")}/demos"
    mkdir(kotlinPkgPath)
}

fun generateCases(): List<Case> {
    val cases = mutableListOf<Case>()
    for (hasClassAnnoOnSuper in arrayOf(true, false)) {
        for (originMethodInSuper in OriginMethodInSuper.values()) {
            for (handlerInSuper in HandlerInSuper.values()) {
                for (hasClassAnnoOnClass in arrayOf(true, false)) {
                    for (originMethodInClass in OriginMethodInClass.values()) {
                        if (!originMethodInSuper.exist && !originMethodInClass.exist) {
                            continue
                        }
                        if (originMethodInSuper.requireOverride && !originMethodInClass.exist) {
                            continue
                        }
                        for (hasHandlerInClass in arrayOf(true, false)) {
                            if (handlerInSuper.requireOverride && !hasHandlerInClass) {
                                continue
                            }
                            cases.add(
                                Case(
                                    sn = "%03d".format(cases.size + 1),
                                    hasClassAnnoOnSuper = hasClassAnnoOnSuper,
                                    originMethodInSuper = originMethodInSuper,
                                    handlerInSuper = handlerInSuper,
                                    hasClassAnnoOnClass = hasClassAnnoOnClass,
                                    originMethodInClass = originMethodInClass,
                                    hasHandlerInClass = hasHandlerInClass,
                                )
                            )
                        }
                    }
                }
            }
        }
    }
    return cases
}

fun generateDemo(basePkg: String, case: Case) {
    logger.lifecycle("generateDemo: $case")
    val javaPkgPath = "src/main/java/${basePkg.replace(".", "/")}/demos"
    val kotlinPkgPath = "src/main/kotlin/${basePkg.replace(".", "/")}/demos"
    generateJavaInterface(javaPkgPath, basePkg, case, "Java")
    generateJavaDemo(javaPkgPath, basePkg, case, "Java")
    generateJavaInterface(javaPkgPath, basePkg, case, "Kotlin")
    generateKotlinDemo(kotlinPkgPath, basePkg, case, "Java")
    generateKotlinInterface(kotlinPkgPath, basePkg, case, "Java")
    generateJavaDemo(javaPkgPath, basePkg, case, "Kotlin")
    generateKotlinInterface(kotlinPkgPath, basePkg, case, "Kotlin")
    generateKotlinDemo(kotlinPkgPath, basePkg, case, "Kotlin")
}

fun generateJavaInterface(pkgPath: String, basePkg: String, case: Case, classLang: String) {
    val interfaceName = "Case${case.sn}JavaInterfaceFor$classLang"
    val file = File("$pkgPath/$interfaceName.java")
    file.writeText(
        """
                        |// Generated by generateDemo task, DO NOT MODIFY
                        |package $basePkg.demos;
                        |
        """.trimMargin()
    )
    if (case.hasClassAnnoOnSuper || case.originMethodInSuper.withAnno) {
        file.appendText(
            """
                        |
                        |import com.alibaba.csp.sentinel.annotation.SentinelResource;
            """.trimMargin()
        )
    }
    val handlerInSuper = case.handlerInSuper.exist && (case.hasClassAnnoOnClass ||
            case.hasClassAnnoOnSuper ||
            case.originMethodInClass.hasAttr ||
            case.originMethodInSuper.hasAttr)
    if (handlerInSuper) {
        if (!case.handlerInSuper.requireOverride) {
            file.appendText(
                """
                        |
                        |import $basePkg.biz.EffAnno;
                        |import $basePkg.biz.HandlerLocation;
                """.trimMargin()
            )
        }
    }
    if (case.originMethodInSuper.exist || handlerInSuper) {
        file.appendText(
            """
                        |
                        |import org.jetbrains.annotations.NotNull;
                        |import org.jetbrains.annotations.Nullable;
           """.trimMargin()
        )
    }
    file.appendText("\n")
    if (handlerInSuper && !case.handlerInSuper.requireOverride) {
        file.appendText(
            """
                        |
                        |import static $basePkg.biz.Greeting.doFallback;
            """.trimMargin()
        )
    }
    if (case.originMethodInSuper.exist && !case.originMethodInSuper.requireOverride) {
        file.appendText(
            """
                        |
                        |import static $basePkg.biz.Greeting.doGreeting;
            """.trimMargin()
        )
    }
    file.appendText("\n")
    file.appendText(
        """
                        |
                        |/**
                        | * Case: $case
                        | */
                        |@SuppressWarnings("unused")
        """.trimMargin()
    )
    if (case.hasClassAnnoOnSuper) {
        file.appendText(
            """
                        |
                        |@SentinelResource(value = "demo", fallback = "superClassHandler")
            """.trimMargin()
        )
    }
    file.appendText(
        """
                        |
                        |public interface $interfaceName {
                        |
        """.trimMargin()
    )
    if (case.originMethodInSuper.exist) {
        if (case.originMethodInSuper.withAnno) {
            val optionalAttr = if (case.originMethodInSuper.hasAttr) ", fallback = \"superMethodHandler\"" else ""
            file.appendText(
                """
                        |
                        |    @SentinelResource(value = "demo"$optionalAttr)
                """.trimMargin()
            )
        }
        if (case.originMethodInSuper.requireOverride) {
            file.appendText(
                """
                        |
                        |    @NotNull
                        |    String greeting(@Nullable String name);
                        |
                """.trimMargin()
            )
        } else {
            file.appendText(
                """
                        |
                        |    @NotNull
                        |    default String greeting(@Nullable String name) {
                        |        return "super:" + doGreeting(name);
                        |    }
                        |
                """.trimMargin()
            )
        }
    }
    if (handlerInSuper) {
        if (case.hasClassAnnoOnSuper) {
            if (case.handlerInSuper.requireOverride) {
                file.appendText(
                    """
                        |
                        |    @NotNull
                        |    String superClassHandler(@Nullable String name, @Nullable Throwable e);
                        |
                        |    @NotNull
                        |    String superClassHandler(@Nullable String name);
                        |
                    """.trimMargin()
                )
            } else {
                file.appendText(
                    """
                        |
                        |    @NotNull
                        |    default String superClassHandler(@Nullable String name, @Nullable Throwable e) {
                        |        return EffAnno.SuperClassAnno.name() + ":" + HandlerLocation.Super.name() + ":" + doFallback(name, e);
                        |    }
                        |
                        |    @NotNull
                        |    default String superClassHandler(@Nullable String name) {
                        |        return EffAnno.SuperClassAnno.name() + ":" + HandlerLocation.Super.name() + ":" + doFallback(name);
                        |    }
                        |
                    """.trimMargin()
                )
            }
        }
        if (case.originMethodInSuper.hasAttr) {
            if (case.handlerInSuper.requireOverride) {
                file.appendText(
                    """
                        |
                        |    @NotNull
                        |    String superMethodHandler(@Nullable String name, @Nullable Throwable e);
                        |
                        |    @NotNull
                        |    String superMethodHandler(@Nullable String name);
                        |
                    """.trimMargin()
                )
            } else {
                file.appendText(
                    """
                        |
                        |    @NotNull
                        |    default String superMethodHandler(@Nullable String name, @Nullable Throwable e) {
                        |        return EffAnno.SuperMethodAnno.name() + ":" + HandlerLocation.Super.name() + ":" + doFallback(name, e);
                        |    }
                        |
                        |    @NotNull
                        |    default String superMethodHandler(@Nullable String name) {
                        |        return EffAnno.SuperMethodAnno.name() + ":" + HandlerLocation.Super.name() + ":" + doFallback(name);
                        |    }
                        |
                    """.trimMargin()
                )
            }
        }
        if (case.hasClassAnnoOnClass) {
            if (case.handlerInSuper.requireOverride) {
                file.appendText(
                    """
                        |
                        |    @NotNull
                        |    String classHandler(@Nullable String name, @Nullable Throwable e);
                        |
                        |    @NotNull
                        |    String classHandler(@Nullable String name);
                        |
                    """.trimMargin()
                )
            } else {
                file.appendText(
                    """
                        |
                        |    @NotNull
                        |    default String classHandler(@Nullable String name, @Nullable Throwable e) {
                        |        return EffAnno.ClassAnno.name() + ":" + HandlerLocation.Super.name() + ":" + doFallback(name, e);
                        |    }
                        |
                        |    @NotNull
                        |    default String classHandler(@Nullable String name) {
                        |        return EffAnno.ClassAnno.name() + ":" + HandlerLocation.Super.name() + ":" + doFallback(name);
                        |    }
                        |
                    """.trimMargin()
                )
            }
        }
        if (case.originMethodInClass.hasAttr) {
            if (case.handlerInSuper.requireOverride) {
                file.appendText(
                    """
                        |
                        |    @NotNull
                        |    String methodHandler(@Nullable String name, @Nullable Throwable e);
                        |
                        |    @NotNull
                        |    String methodHandler(@Nullable String name);
                        |
                    """.trimMargin()
                )
            } else {
                file.appendText(
                    """
                        |
                        |    @NotNull
                        |    default String methodHandler(@Nullable String name, @Nullable Throwable e) {
                        |        return EffAnno.MethodAnno.name() + ":" + HandlerLocation.Super.name() + ":" + doFallback(name, e);
                        |    }
                        |
                        |    @NotNull
                        |    default String methodHandler(@Nullable String name) {
                        |        return EffAnno.MethodAnno.name() + ":" + HandlerLocation.Super.name() + ":" + doFallback(name);
                        |    }
                        |
                    """.trimMargin()
                )
            }
        }
    }
    file.appendText(
        """
                        |
                        |}
                        |
        """.trimMargin()
    )
}

fun generateJavaDemo(pkgPath: String, basePkg: String, case: Case, interfaceLang: String) {
    val className = "Case${case.sn}${interfaceLang}InterfaceJavaDemo"
    val file = File("$pkgPath/$className.java")
    file.writeText(
        """
                        |// Generated by generateDemo task, DO NOT MODIFY
                        |package $basePkg.demos;
                        |
        """.trimMargin()
    )
    if (case.hasClassAnnoOnClass || case.originMethodInClass.withAnno) {
        file.appendText(
            """
                        |
                        |import com.alibaba.csp.sentinel.annotation.SentinelResource;
            """.trimMargin()
        )
    }
    val hasHandlerInClass = case.hasHandlerInClass && (case.hasClassAnnoOnClass ||
            case.hasClassAnnoOnSuper ||
            case.originMethodInClass.hasAttr ||
            case.originMethodInSuper.hasAttr)
    if (hasHandlerInClass) {
        file.appendText(
            """
                        |
                        |import $basePkg.biz.EffAnno;
                        |import $basePkg.biz.HandlerLocation;
            """.trimMargin()
        )
    }
    if (case.originMethodInClass.exist || hasHandlerInClass) {
        file.appendText(
            """
                        |
                        |import org.jetbrains.annotations.NotNull;
                        |import org.jetbrains.annotations.Nullable;
           """.trimMargin()
        )
    }
    file.appendText(
        """
                        |
                        |import org.springframework.stereotype.Component;
                        |
        """.trimMargin()
    )
    if (hasHandlerInClass) {
        file.appendText(
            """
                        |
                        |import static $basePkg.biz.Greeting.doFallback;
            """.trimMargin()
        )
    }
    if (case.originMethodInClass.exist) {
        file.appendText(
            """
                        |import static $basePkg.biz.Greeting.doGreeting;
            """.trimMargin()
        )
    }
    if (hasHandlerInClass || case.originMethodInClass.exist) {
        file.appendText("\n")
    }
    file.appendText(
        """
                        |
                        |/**
                        | * Case: $case
                        | */
                        |@SuppressWarnings("unused")
        """.trimMargin()
    )
    if (case.hasClassAnnoOnClass) {
        file.appendText(
            """
                        |
                        |@SentinelResource(value = "demo", fallback = "classHandler")
            """.trimMargin()
        )
    }
    file.appendText(
        """
                        |
                        |@Component
                        |public class $className implements Case${case.sn}${interfaceLang}InterfaceForJava {
                        |
        """.trimMargin()
    )
    if (case.originMethodInClass.exist) {
        if (case.originMethodInClass.withAnno) {
            val optionalAttr = if (case.originMethodInClass.hasAttr) ", fallback = \"methodHandler\"" else ""
            file.appendText(
                """
                        |
                        |    @SentinelResource(value = "demo"$optionalAttr)
                """.trimMargin()
            )
        }
        if (case.originMethodInSuper.exist) {
            file.appendText(
                """
                        |
                        |    @Override
                """.trimMargin()
            )
        }
        file.appendText(
            """
                        |
                        |    @NotNull
                        |    public String greeting(@Nullable String name) {
                        |        return doGreeting(name);
                        |    }
                        |
            """.trimMargin()
        )
    }
    if (hasHandlerInClass) {
        if (case.hasClassAnnoOnSuper) {
            if (case.handlerInSuper.exist) {
                file.appendText(
                    """
                        |
                        |    @Override
                    """.trimMargin()
                )
            }
            file.appendText(
                """
                        |
                        |    @NotNull
                        |    public String superClassHandler(@Nullable String name, @Nullable Throwable e) {
                        |        return EffAnno.SuperClassAnno.name() + ":" + HandlerLocation.Class.name() + ":" + doFallback(name, e);
                        |    }
                        |
                        |    @NotNull
                        |    public String superClassHandler(@Nullable String name) {
                        |        return EffAnno.SuperClassAnno.name() + ":" + HandlerLocation.Class.name() + ":" + doFallback(name);
                        |    }
                        |
                """.trimMargin()
            )
        }
        if (case.originMethodInSuper.hasAttr) {
            if (case.handlerInSuper.exist) {
                file.appendText(
                    """
                        |
                        |    @Override
                    """.trimMargin()
                )
            }
            file.appendText(
                """
                        |
                        |    @NotNull
                        |    public String superMethodHandler(@Nullable String name, @Nullable Throwable e) {
                        |        return EffAnno.SuperMethodAnno.name() + ":" + HandlerLocation.Class.name() + ":" + doFallback(name, e);
                        |    }
                        |
                """.trimMargin()
            )
            if (case.handlerInSuper.exist) {
                file.appendText(
                    """
                        |
                        |    @Override
                    """.trimMargin()
                )
            }
            file.appendText(
                """
                        |
                        |    @NotNull
                        |    public String superMethodHandler(@Nullable String name) {
                        |        return EffAnno.SuperMethodAnno.name() + ":" + HandlerLocation.Class.name() + ":" + doFallback(name);
                        |    }
                        |
                """.trimMargin()
            )
        }
        if (case.hasClassAnnoOnClass) {
            if (case.handlerInSuper.exist) {
                file.appendText(
                    """
                        |
                        |    @Override
                    """.trimMargin()
                )
            }
            file.appendText(
                """
                        |
                        |    @NotNull
                        |    public String classHandler(@Nullable String name, @Nullable Throwable e) {
                        |        return EffAnno.ClassAnno.name() + ":" + HandlerLocation.Class.name() + ":" + doFallback(name, e);
                        |    }
                        |
                """.trimMargin()
            )
            if (case.handlerInSuper.exist) {
                file.appendText(
                    """
                        |
                        |    @Override
                    """.trimMargin()
                )
            }
            file.appendText(
                """
                        |
                        |    @NotNull
                        |    public String classHandler(@Nullable String name) {
                        |        return EffAnno.ClassAnno.name() + ":" + HandlerLocation.Class.name() + ":" + doFallback(name);
                        |    }
                        |
                """.trimMargin()
            )
        }
        if (case.originMethodInClass.hasAttr) {
            if (case.handlerInSuper.exist) {
                file.appendText(
                    """
                        |
                        |    @Override
                    """.trimMargin()
                )
            }
            file.appendText(
                """
                        |
                        |    @NotNull
                        |    public String methodHandler(@Nullable String name, @Nullable Throwable e) {
                        |        return EffAnno.MethodAnno.name() + ":" + HandlerLocation.Class.name() + ":" + doFallback(name, e);
                        |    }
                        |
                """.trimMargin()
            )
            if (case.handlerInSuper.exist) {
                file.appendText(
                    """
                        |
                        |    @Override
                    """.trimMargin()
                )
            }
            file.appendText(
                """
                        |
                        |    @NotNull
                        |    public String methodHandler(@Nullable String name) {
                        |        return EffAnno.MethodAnno.name() + ":" + HandlerLocation.Class.name() + ":" + doFallback(name);
                        |    }
                        |
                """.trimMargin()
            )
        }
    }
    file.appendText(
        """
                        |
                        |}
                        |
        """.trimMargin()
    )
}

fun generateKotlinInterface(pkgPath: String, basePkg: String, case: Case, classLang: String) {
    val interfaceName = "Case${case.sn}KotlinInterfaceFor$classLang"
    val file = File("$pkgPath/$interfaceName.kt")
    file.writeText(
        """
                        |// Generated by generateDemo task, DO NOT MODIFY
                        |package $basePkg.demos
                        |
        """.trimMargin()
    )
    if (case.hasClassAnnoOnSuper || case.originMethodInSuper.withAnno) {
        file.appendText(
            """
                        |
                        |import com.alibaba.csp.sentinel.annotation.SentinelResource
            """.trimMargin()
        )
    }
    val handlerInSuper = case.handlerInSuper.exist && (case.hasClassAnnoOnClass ||
            case.hasClassAnnoOnSuper ||
            case.originMethodInClass.hasAttr ||
            case.originMethodInSuper.hasAttr)
    if (handlerInSuper) {
        if (!case.handlerInSuper.requireOverride) {
            file.appendText(
                """
                        |
                        |import $basePkg.biz.EffAnno
                """.trimMargin()
            )
        }
    }
    if (
        (case.originMethodInSuper.exist && !case.originMethodInSuper.requireOverride)
        || (handlerInSuper && !case.handlerInSuper.requireOverride)
    ) {
        file.appendText(
            """
                        |
                        |import $basePkg.biz.Greeting
            """.trimMargin()
        )
    }
    if (handlerInSuper && !case.handlerInSuper.requireOverride) {
        file.appendText(
            """
                        |
                        |import $basePkg.biz.HandlerLocation
            """.trimMargin()
        )
    }
    file.appendText("\n")
    file.appendText(
        """
                        |
                        |/**
                        | * Case: $case
                        | */
        """.trimMargin()
    )
    if (case.hasClassAnnoOnSuper) {
        file.appendText(
            """
                        |
                        |@SentinelResource(value = "demo", fallback = "superClassHandler")
            """.trimMargin()
        )
    }
    if (case.originMethodInSuper.exist || handlerInSuper) {
        file.appendText(
            """
                        |
                        |interface $interfaceName {
                        |
            """.trimMargin()
        )
    } else {
        file.appendText(
            """
                        |
                        |interface $interfaceName
                        |
            """.trimMargin()
        )
    }
    if (case.originMethodInSuper.exist) {
        if (case.originMethodInSuper.withAnno) {
            val optionalAttr = if (case.originMethodInSuper.hasAttr) ", fallback = \"superMethodHandler\"" else ""
            file.appendText(
                """
                        |
                        |    @SentinelResource(value = "demo"$optionalAttr)
                """.trimMargin()
            )
        }
        if (case.originMethodInSuper.requireOverride) {
            file.appendText(
                """
                        |
                        |    fun greeting(name: String?): String
                        |
                """.trimMargin()
            )
        } else {
            file.appendText(
                """
                        |
                        |    fun greeting(name: String?): String = "super:" + Greeting.doGreeting(name)
                        |
                """.trimMargin()
            )
        }
    }
    if (handlerInSuper) {
        if (case.hasClassAnnoOnSuper) {
            if (case.handlerInSuper.requireOverride) {
                file.appendText(
                    """
                        |
                        |    fun superClassHandler(name: String?, e: Throwable?): String
                        |
                        |    fun superClassHandler(name: String?): String
                        |
                    """.trimMargin()
                )
            } else {
                file.appendText(
                    """
                        |
                        |    fun superClassHandler(name: String?, e: Throwable?): String {
                        |        return EffAnno.SuperClassAnno.name + ":" + HandlerLocation.Super.name + ":" + Greeting.doFallback(name, e)
                        |    }
                        |
                        |    fun superClassHandler(name: String?): String {
                        |        return EffAnno.SuperClassAnno.name + ":" + HandlerLocation.Super.name + ":" + Greeting.doFallback(name)
                        |    }
                        |
                    """.trimMargin()
                )
            }
        }
        if (case.originMethodInSuper.hasAttr) {
            if (case.handlerInSuper.requireOverride) {
                file.appendText(
                    """
                        |
                        |    fun superMethodHandler(name: String?, e: Throwable?): String
                        |
                        |    fun superMethodHandler(name: String?): String
                        |
                    """.trimMargin()
                )
            } else {
                file.appendText(
                    """
                        |
                        |    fun superMethodHandler(name: String?, e: Throwable?): String {
                        |        return EffAnno.SuperMethodAnno.name + ":" + HandlerLocation.Super.name + ":" + Greeting.doFallback(name, e)
                        |    }
                        |
                        |    fun superMethodHandler(name: String?): String {
                        |        return EffAnno.SuperMethodAnno.name + ":" + HandlerLocation.Super.name + ":" + Greeting.doFallback(name)
                        |    }
                        |
                    """.trimMargin()
                )
            }
        }
        if (case.hasClassAnnoOnClass) {
            if (case.handlerInSuper.requireOverride) {
                file.appendText(
                    """
                        |
                        |    fun classHandler(name: String?, e: Throwable?): String
                        |
                        |    fun classHandler(name: String?): String
                        |
                    """.trimMargin()
                )
            } else {
                file.appendText(
                    """
                        |
                        |    fun classHandler(name: String?, e: Throwable?): String {
                        |        return EffAnno.ClassAnno.name + ":" + HandlerLocation.Super.name + ":" + Greeting.doFallback(name, e)
                        |    }
                        |
                        |    fun classHandler(name: String?): String {
                        |        return EffAnno.ClassAnno.name + ":" + HandlerLocation.Super.name + ":" + Greeting.doFallback(name)
                        |    }
                        |
                    """.trimMargin()
                )
            }
        }
        if (case.originMethodInClass.hasAttr) {
            if (case.handlerInSuper.requireOverride) {
                file.appendText(
                    """
                        |
                        |    fun methodHandler(name: String?, e: Throwable?): String
                        |
                        |    fun methodHandler(name: String?): String
                        |
                    """.trimMargin()
                )
            } else {
                file.appendText(
                    """
                        |
                        |    fun methodHandler(name: String?, e: Throwable?): String {
                        |        return EffAnno.MethodAnno.name + ":" + HandlerLocation.Super.name + ":" + Greeting.doFallback(name, e)
                        |    }
                        |
                        |    fun methodHandler(name: String?): String {
                        |        return EffAnno.MethodAnno.name + ":" + HandlerLocation.Super.name + ":" + Greeting.doFallback(name)
                        |    }
                        |
                    """.trimMargin()
                )
            }
        }
    }
    if (case.originMethodInSuper.exist || handlerInSuper) {
        file.appendText(
            """
                        |
                        |}
                        |
            """.trimMargin()
        )
    }
}

fun generateKotlinDemo(pkgPath: String, basePkg: String, case: Case, interfaceLang: String) {
    val className = "Case${case.sn}${interfaceLang}InterfaceKotlinDemo"
    val file = File("$pkgPath/$className.kt")
    file.writeText(
        """
                        |// Generated by generateDemo task, DO NOT MODIFY
                        |package $basePkg.demos
                        |
        """.trimMargin()
    )
    if (case.hasClassAnnoOnClass || case.originMethodInClass.withAnno) {
        file.appendText(
            """
                        |
                        |import com.alibaba.csp.sentinel.annotation.SentinelResource
            """.trimMargin()
        )
    }
    val hasHandlerInClass = case.hasHandlerInClass && (case.hasClassAnnoOnClass ||
            case.hasClassAnnoOnSuper ||
            case.originMethodInClass.hasAttr ||
            case.originMethodInSuper.hasAttr)
    if (hasHandlerInClass) {
        file.appendText(
            """
                        |
                        |import $basePkg.biz.EffAnno
            """.trimMargin()
        )
    }
    if (case.originMethodInClass.exist || hasHandlerInClass) {
        file.appendText(
            """
                        |
                        |import $basePkg.biz.Greeting
            """.trimMargin()
        )
    }
    if (hasHandlerInClass) {
        file.appendText(
            """
                        |
                        |import $basePkg.biz.HandlerLocation
            """.trimMargin()
        )
    }
    file.appendText(
        """
                        |
                        |import org.springframework.stereotype.Component
                        |
                        |/**
                        | * Case: $case
                        | */
        """.trimMargin()
    )
    if (case.hasClassAnnoOnClass) {
        file.appendText(
            """
                        |
                        |@SentinelResource(value = "demo", fallback = "classHandler")
            """.trimMargin()
        )
    }
    file.appendText(
        """
                        |
                        |@Component
                        |class $className : Case${case.sn}${interfaceLang}InterfaceForKotlin
        """.trimMargin()
    )
    if (case.originMethodInClass.exist || hasHandlerInClass) {
        file.appendText(" {\n")
    } else {
        file.appendText("\n")
    }
    if (case.originMethodInClass.exist) {
        if (case.originMethodInClass.withAnno) {
            val optionalAttr = if (case.originMethodInClass.hasAttr) ", fallback = \"methodHandler\"" else ""
            file.appendText(
                """
                        |
                        |    @SentinelResource(value = "demo"$optionalAttr)
                """.trimMargin()
            )
        }
        val optionalOverrideKeyword = if (case.originMethodInSuper.exist) "override " else ""
        file.appendText(
            """
                        |
                        |    ${optionalOverrideKeyword}fun greeting(name: String?): String {
                        |        return Greeting.doGreeting(name)
                        |    }
                        |
            """.trimMargin()
        )
    }
    if (case.hasHandlerInClass) {
        val optionalOverrideKeyword = if (case.handlerInSuper.exist) "override " else ""
        if (case.hasClassAnnoOnSuper) {
            file.appendText(
                """
                        |
                        |    ${optionalOverrideKeyword}fun superClassHandler(name: String?, e: Throwable?): String {
                        |        return EffAnno.SuperClassAnno.name + ":" + HandlerLocation.Class.name + ":" + Greeting.doFallback(name, e)
                        |    }
                        |
                        |    ${optionalOverrideKeyword}fun superClassHandler(name: String?): String {
                        |        return EffAnno.SuperClassAnno.name + ":" + HandlerLocation.Class.name + ":" + Greeting.doFallback(name)
                        |    }
                        |
                """.trimMargin()
            )
        }
        if (case.originMethodInSuper.hasAttr) {
            file.appendText(
                """
                        |
                        |    ${optionalOverrideKeyword}fun superMethodHandler(name: String?, e: Throwable?): String {
                        |        return EffAnno.SuperMethodAnno.name + ":" + HandlerLocation.Class.name + ":" + Greeting.doFallback(name, e)
                        |    }
                        |
                        |    ${optionalOverrideKeyword}fun superMethodHandler(name: String?): String {
                        |        return EffAnno.SuperMethodAnno.name + ":" + HandlerLocation.Class.name + ":" + Greeting.doFallback(name)
                        |    }
                        |
                """.trimMargin()
            )
        }
        if (case.hasClassAnnoOnClass) {
            file.appendText(
                """
                        |
                        |    ${optionalOverrideKeyword}fun classHandler(name: String?, e: Throwable?): String {
                        |        return EffAnno.ClassAnno.name + ":" + HandlerLocation.Class.name + ":" + Greeting.doFallback(name, e)
                        |    }
                        |
                        |    ${optionalOverrideKeyword}fun classHandler(name: String?): String {
                        |        return EffAnno.ClassAnno.name + ":" + HandlerLocation.Class.name + ":" + Greeting.doFallback(name)
                        |    }
                        |
                """.trimMargin()
            )
        }
        if (case.originMethodInClass.hasAttr) {
            file.appendText(
                """
                        |
                        |    ${optionalOverrideKeyword}fun methodHandler(name: String?, e: Throwable?): String {
                        |        return EffAnno.MethodAnno.name + ":" + HandlerLocation.Class.name + ":" + Greeting.doFallback(name, e)
                        |    }
                        |
                        |    ${optionalOverrideKeyword}fun methodHandler(name: String?): String {
                        |        return EffAnno.MethodAnno.name + ":" + HandlerLocation.Class.name + ":" + Greeting.doFallback(name)
                        |    }
                        |
                """.trimMargin()
            )
        }
    }
    if (case.originMethodInClass.exist || hasHandlerInClass) {
        file.appendText(
            """
                        |
                        |}
                        |
            """.trimMargin()
        )
    }
}

fun generateCaseRunner(basePkg: String, case: Case) {
    val className = "Case${case.sn}Runner"
    val pkgPath = "src/main/java/${basePkg.replace(".", "/")}/demos"
    val file = File("$pkgPath/$className.java")
    file.writeText(
        """
            package $basePkg.demos;

            import lombok.extern.slf4j.Slf4j;
            import org.jetbrains.annotations.NotNull;
            import org.springframework.beans.BeansException;
            import org.springframework.boot.CommandLineRunner;
            import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
            import org.springframework.context.ApplicationContext;
            import org.springframework.context.ApplicationContextAware;
            import org.springframework.core.annotation.Order;
            import org.springframework.stereotype.Component;

            import static $basePkg.biz.Run.detectEffectiveness;
            import static $basePkg.biz.Run.detectProxyType;

            @ConditionalOnProperty(name = "run.only", havingValue = "case${case.sn}", matchIfMissing = true)
            @Component
            @Slf4j
            @Order(${case.sn.toInt()})
            public class $className implements CommandLineRunner, ApplicationContextAware {
                private ApplicationContext applicationContext;

                @Override
                public void setApplicationContext(@NotNull ApplicationContext applicationContext) throws BeansException {
                    this.applicationContext = applicationContext;
                }

                @Override
                public void run(String... args) {
                    String proxyType = detectProxyType(applicationContext, "${case.sn}");
                    log.info("case result: {},{},{}",
                            String.join(",",
                                    "${case.sn}",
                                    "${if (case.hasClassAnnoOnSuper) "Yes" else "No"}",
                                    "${case.originMethodInSuper.name}",
                                    "${case.handlerInSuper.name}",
                                    "${if (case.hasClassAnnoOnClass) "Yes" else "No"}",
                                    "${case.originMethodInClass.name}",
                                    "${if (case.hasHandlerInClass) "Yes" else "No"}"
                                    ),
                            detectEffectiveness(applicationContext, "${case.sn}"),
                            proxyType);
                }
            }

        """.trimIndent()
    )
}

data class Case(
    val sn: String,
    val hasClassAnnoOnSuper: Boolean,
    val originMethodInSuper: OriginMethodInSuper,
    val handlerInSuper: HandlerInSuper,
    val hasClassAnnoOnClass: Boolean,
    val originMethodInClass: OriginMethodInClass,
    val hasHandlerInClass: Boolean,
)

enum class OriginMethodInSuper(
    val exist: Boolean,
    val withAnno: Boolean,
    val hasAttr: Boolean,
    val requireOverride: Boolean
) {
    WithAnnoHavingAttrWithBody(true, true, true, false),
    WithAnnoHavingAttrAbstract(true, true, true, true),
    WithAnnoNoAttrWithBody(true, true, false, false),
    WithAnnoNoAttrAbstract(true, true, false, true),
    WithoutAnnoWithBody(true, false, false, false),
    WithoutAnnoAbstract(true, false, false, true),
    None(false, false, false, false),
}

enum class HandlerInSuper(val exist: Boolean, val requireOverride: Boolean) {
    WithBody(true, false),
    Abstract(true, true),
    None(false, false),
}

enum class OriginMethodInClass(val exist: Boolean, val withAnno: Boolean, val hasAttr: Boolean) {
    WithAnnoHavingAttr(true, true, true),
    WithAnnoNoAttr(true, true, false),
    WithoutAnno(true, false, false),
    None(false, false, false),
}
